# Background

## 문제점

지금 소속 되어 있는 제 회사에서 유지보수 중인 킬링 솔루션들의 비즈니스 로직이 EUC-KR charset을 사용한 DB Package로 소스코드를 유지합니다.

현재 회사에서 제가 없을 시절에 개발 문화를 애자일 방법론을 채택하고, 인프라의 자동 배포가 추가되면서 CI/CD가 구성되었지만 DB Package 자동배포는 실패하였습니다.

이전 동료들은 쉘 명령어를 사용한 자동 배포 방법을 채택하였으나, 이는 한글 깨짐 현상으로 인해 벽에 맞닥뜨리고 말았습니다.

이로 인해 현재 저희 개발팀의 소스코드를 자동으로 서버에 배포하는 CI/CD 프로세스가 웹 서버만 구성되었으며 그 결과, 매 정기 및 비정기 이관마다 사람이 직접 이관해야 하는 상황이 발생했습니다.

이러한 수동 이관 프로세스에서는 다수의 Human error가 발생하였습니다.

최신 소스코드가 반영되지 않은 경우

- 파일이 깨진 경우
- 양방향 의존성으로 인한 순서 보장이 되지 않아 발생하는 컴파일 에러
- 배포를 담당하는 사람을 고정하였으나 인원 변경으로 인한 이관 시간 증가
- 위와 같은 Human error가 프로세스의 효율성과 안정성에 부정적인 영향을 미치고 있습니다.

또한 배포의 시간까지 이 문제점은 곪아갔습니다.

빠를 때는 3분 ~ 5분 정도밖에 걸리지 않는 작업이었지만,

큰 이관이 있는 날에는 30분, 많게는 1시간까지 배포와 검증 2개의 프로세스에서 발생하는 시간이었습니다.

위에서 나열된 이슈로 인해 저희팀은 매번 이관에서 굉장히 비효율적, 원시적인 문제가 발생한 상태였습니다.

## 생각의 전환

작년 이 비효율을 해결하기 위해서 저는 배포를 건드릴 수 없다면, 평소 관리 방식에 접근해 위 문제를 해결하고자 했습니다.

그 시도가 바로 Package History Manger 였습니다.

'제가 들었던 내용은 자동 이관을 시도 하였으나, 실패했다' 라는 기존의 동료분들의 전래동화였기에

저 또한 '자동 이관은 불가능해 옛날에 시도했었지만, 결국 실패했었잖아' 라며 방법 찾아보려는 노력조차 하지 않았죠.

그래서 제가 Package History Manager에서 시도했던 것은 'Package 관리 Point를 하나로 묶어 이관 시 이 파일을 하나로 묶는 것을 시도해보자.' 였습니다.

그렇게 첫 이관에서 사용한 제 프로그램은 생각보다 좋은 유저 피드백을 얻을 수 있었습니다.

- 이관 이후 파일이 잘못될 가능성이 없으니, 추후에는 배포한 결과를 <span style="color: red;">_확인_</span>하지 않아도 되는 방향으로 프로세스가 단축될 것 같다.
- 패키지를 일일이 눈으로 <span style="color: red;">_확인_</span>하지 않아도 되니 배포 시간이 단축 되었다.
- 파일이 옛날 파일일리 없으니, 그걸 <span style="color: red;">_확인_</span>하는 시간도 단축되어 이관에 더 집중할 수 있게 되었다.
  동료 개발자들의 피드백에서 공통적으로 얻어냈던 그 하나의 키워드.

## <span style="color: gray;">_확인_</span>

'확인'이라는 키워드였습니다.

모든 이들이 Package 이관에서 거론하는 문제점.

이때가지 수없이 진행된 이관으로 쌓여진 데이터는 Human error 로 인한 이관 스트레스 증가.

해당 키워드를 얻어낸 저는 Package History Manager가 이를 완벽히는 몰라도 일정 부분 해소해줄 것이라 믿었습니다.

그러나, 무료 도메인을 사용한 제 서버는 매달 도메인 유지를 해주어야 하는 귀찮은 작업 동반과 매일 풀로 돌아가는 제 개인 PC로 인해 중간 유지보수를 포기하게 되었습니다.

저는 그렇게 우리의 Package 이관은 '확인에서 시간이 많이 발생하고 있었구나' 라는 깨달음만 얻은 채 해당 프로젝트를 폐기하였습니다.

## <span style="color: gray;">_그렇다면, 이 문제점들. 어떻게 해결할 수는 없을까?_</span>

해결 방법은 생각보다 훨씬 간단했습니다.

개발자들의 익숙함으로 인해 생각이 거기에 닿지 못하였을뿐.

기존 배포 방식에서 실패한 이유는 한글 깨짐 현상입니다.

이는 이전 Package History Manager에서 Package 파일 묶기 기능에서 사용했던 방법을 사용하면, 쉽게 해결될 것이라 판단했습니다.

간단히 sql 파일을 binary 형식으로 읽어 그에 알맞는 텍스트 형식을 사용하면 해결되는 일이죠

- sql 파일을 binary 형식으로 불러온다.
- Buffer 를 이용해 다시 읽어내며, EUC-KR 형식으로 변환한다. (with. iconv lib)
- 불러온 문자열을 oracledb lib를 통해 실행한다.

위와 같이 방법은 심플하기에 아이디어는 금방 떠올라 프로젝트를 시작했습니다.

언어는 빠르게 진행하기 위해 Python, Node.js 두개로 추려 서로의 라이브러리를 모두 사용해봤습니다.

기존 Python으로 시도해봤지만, Python에서는 필수적으로 Oracle instant client가 필요했기에 보다 설정이 간편한 Node.js로 최종적으로 선택하였습니다.
(결론적으로 보면, 특정 버전을 지원해야 하는 요구사항이 생겨 Thick mode를 활용하며 똑같아지긴 했습니다.)

# 마무리

소스 코드 내 규칙은 모두 제 팀에서 사용하는 방식을 맞추어 개발하였지만, 최대한 관심사를 분리하고자 노력하였습니다.

누군가가 제 코드를 사용해 패키지 자동배포를 성공하기를 바라며...

이렇게 간단한 소스코드에 대한 Background를 기입하였습니다.
